<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>deviceConfig</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bm.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bminterface.js"></script>

    <style type="text/css">

    </style>

    <script>

        function updateThis(fileName) {

            console.log();
            $('#myModal').modal('show');
            dangerMsg("升级包:" + fileName + "解压中,请勿关闭!");

            bm_ajax("DecodeTarGz", "&fileName=" + fileName, function (json) {
                    console.log(json);
                    if (json["return"]) {
                        successMsg("解压完毕! 1分钟后重启.");
                        loadBackUp();
                    }
                });

        }

        function loadUpdateFileHtml(json) {
            var html = "";
            if (json) {
                var Num = json.length;
                var thead_str = "";
                var tbody_str = "";

                if (Num > 0) {
                    thead_str += "<tr>";
                    for (var key in json[0]) {
                        thead_str += "<th>" + key + "</th>";
                    }
                    thead_str += "<th>操作</th>";
                    thead_str += "</tr>";
                }

                for (var i = 0; i < Num; i++) {
                    tbody_str += "<tr>"
                    for (var key in json[i]) {
                        tbody_str += "<td>" + json[i][key] + "</td>";
                    }
                    tbody_str += "<td><button type=\"button\" class=\"btn btn-primary btn-xs\"  onclick=\"updateThis('" + json[i][key] + "')\">部署</button></td>";
                    tbody_str += "</tr>"
                }

                bm_html("thead_updateFile", thead_str);
                bm_html("tbody_updateFile", tbody_str);
            } 

        }

        function loadUpdateFile() {

            bm_ajax("SelectUpdateTarGz", "", function (json) {
                console.log(json);
                if (json["return"]) {
                    loadUpdateFileHtml(json["value"])
                }
            });

        }

        function loadSlaveInfoHtml(json) {
            var html = "";
            if (json) {
                var Num = json.length;
                var thead_str = "";
                var tbody_str = "";

                if (Num > 0) {
                    thead_str += "<tr>";
                    for (var key in json[0]) {
                        thead_str += "<th>" + key + "</th>";
                    }
                    thead_str += "<th>alive</th>";
                    thead_str += "<th>softVersion</th>";
                    thead_str += "<th>algVersion</th>";
                    thead_str += "</tr>";
                }

                for (var i = 0; i < Num; i++) {
                    tbody_str += "<tr>"
                    for (var key in json[i]) {
                        tbody_str += "<td>" + json[i][key] + "</td>";
                    }
                    tbody_str += "<td id=\"alive_" + i + "\">off</td>";
                    tbody_str += "<td id=\"softVersion_" + i + "\">off</td>";
                    tbody_str += "<td id=\"algVersion_" + i + "\">off</td>";
                    tbody_str += "</tr>"
                }

                bm_html("thead_slaveInfo", thead_str);
                bm_html("tbody_slaveInfo", tbody_str);
            }

        }

        function checkSlaveAlive(json) {
            if (json) {
                var Num = json.length;
                for (var i = 0; i < Num; i++) {
                    bm_slave_ajax(json[i]["ip"], "KeepAlive", i,"", function (id,rjson) {
                        if (rjson["return"]) {
                            bm_html("alive_" + id, "online");
                            bm_html("softVersion_" + id, rjson["version"]);
                            bm_html("algVersion_" + id, rjson["algVersion"]);
                        }
                    });
                }

            }
        }

        var _slaveInfoJson;

        function loadSlaveInfo() {

            bm_ajax("GetSlaveInfo", "", function (json) {
                _slaveInfoJson = json;
                if (json["return"]) {
                    loadSlaveInfoHtml(json["value"]);
                    checkSlaveAlive(json["value"]);
                }
            });

        }

        function checkSlave() {
            if (_slaveInfoJson["return"]) {
                checkSlaveAlive(_slaveInfoJson["value"]);
            }
        }

        function loadBackUpHtml(json) {
            var html = "";
            if (json) {
                var Num = json.length;
                var thead_str = "";
                var tbody_str = "";


                if (Num > 0) {
                    thead_str += "<tr>";
                    for (var key in json[0]) {
                        thead_str += "<th>" + key + "</th>";
                    }
                    thead_str += "<th>操作</th>";
                    thead_str += "</tr>";
                }

                for (var i = 0; i < Num; i++) {
                    tbody_str += "<tr>"
                    for (var key in json[i]) {
                        tbody_str += "<td>" + json[i][key] + "</td>";
                    }
                    tbody_str += "<td><button type=\"button\" class=\"btn btn-primary btn-xs\"  onclick=\"backupThis('" + json[i][key] + "')\">部署</button></td>";
                    tbody_str += "</tr>"
                }

                bm_html("thead_backup", thead_str);
                bm_html("tbody_backup", tbody_str);
            }

        }

        function loadBackUp() {

            bm_ajax("SelectBackUp", "", function (json) {
                _slaveInfoJson = json;
                if (json["return"]) {
                    loadBackUpHtml(json["value"]);
                }
            });

        }


        function onload() {
            loadUpdateFile();
            loadSlaveInfo();
            loadBackUp();


            //setTimeout("checkSlave()", 10000);
        }


        function ConfigMenuBarClick(clickelement, id) {
            $("#div_configMenuBar a").removeClass("active");
            clickelement.setAttribute("class", "list-group-item active");
            $("#div_ConfigMain > div").hide();
            $("#" + id).show();
        }



        function fileSelected() {
            var file = document.getElementById('fileToUpload').files[0];
            if (file) {
                var fileSize = 0;
                if (file.size > 1024 * 1024)
                    fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
                else
                    fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
                document.getElementById('fileName').innerHTML = 'Name: ' + file.name;
                document.getElementById('fileSize').innerHTML = 'Size: ' + fileSize;
                document.getElementById('fileType').innerHTML = 'Type: ' + file.type;
            }
        }

        function uploadFile() {
            var randid = randnum();
            var pwd = mkpwd(getCookie("pwd"), randid);

            var fd = new FormData();
            fd.append("fileToUpload", document.getElementById('fileToUpload').files[0]);
            var xhr = new XMLHttpRequest();
            xhr.upload.addEventListener("progress", uploadProgress, false);
            xhr.addEventListener("load", uploadComplete, false);
            xhr.addEventListener("error", uploadFailed, false);
            xhr.addEventListener("abort", uploadCanceled, false);
                xhr.open("POST", "cgi/UploadRelaseFile"+"?randid=" + randid + "&pwd=" + pwd); //修改成自己的接口
            xhr.send(fd);


            $("#div_per_main").show();
            dangerMsg("升级文件上传中!");
            $('#myModal').modal('show');
        }

        function uploadProgress(evt) {
            if (evt.lengthComputable) {
                var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                document.getElementById('div_per').style.width = percentComplete.toString() + '%';
            } else {
                document.getElementById('progressNumber').innerHTML = 'unable to compute';
            }
        }

        function uploadComplete(evt) {
            /* 服务器端返回响应时候触发event事件*/
            //alert(evt.target.responseText);

            successMsg("上传完毕!");
            loadUpdateFile();
            
        }

        function uploadFailed(evt) {
            alert("There was an error attempting to upload the file.");
        }

        function uploadCanceled(evt) {
            alert("The upload has been canceled by the user or the browser dropped the connection.");
        }


        function successMsg(msg) {
            bm_html("div_MsgOut", "<div class=\"alert alert-success\" style=\"max-width:400px\" >" + msg + "</div >");
        }
        function dangerMsg(msg) {
            bm_html("div_MsgOut", "<div class=\"alert alert-danger\" style=\"max-width:400px\" >" + msg + "</div >");
        }

    </script>

    <style>

    </style>
</head>
<body onload="onload();">

    <div class="row" style="max-width:100%;">
        <div id="div_configMenuBar" class="col-sm-2">
            <a href="#" class="list-group-item active" onclick="ConfigMenuBarClick(this,'div_updateFile')">升级包管理</a>
        </div>
        <div id="div_ConfigMain" class="col-sm-8">
            

            <div id="div_updateFile" class="row">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            升级包管理
                        </h3>
                    </div>
                    <div class="panel-body">
                        <div class="panel panel-default">
                            <div class="panel-body">

                                <form id="uploadFrom" enctype="multipart/form-data" method="post" action="Upload">
                                    <table class="table table-bordered table-striped table-hover table-condensed">
                                        <thead><tr><th>Select a File to Upload</th></tr></thead>
                                        <tbody>
                                            <tr><td><input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();"></td></tr>
                                            <tr>
                                                <td></td>
                                            </tr>
                                            <tr><td><input type="button" onclick="uploadFile()" value="Upload"></td></tr>
                                            <tr><td><div id="fileName"></div></td></tr>
                                            <tr><td><div id="fileSize"></div></td></tr>
                                            <tr><td><div id="fileType"></div></td></tr>
                                        </tbody>
                                    </table>
                                </form>

                                <table class="table table-bordered table-striped table-hover table-condensed">
                                    <thead id="thead_backup"> </thead>
                                    <tbody id="tbody_backup"> </tbody>
                                </table>

                                <table class="table table-bordered table-striped table-hover table-condensed">
                                    <thead id="thead_updateFile"> </thead>
                                    <tbody id="tbody_updateFile"> </tbody>
                                </table>

                                <table class="table table-bordered table-striped table-hover table-condensed">
                                    <thead id="thead_slaveInfo"> </thead>
                                    <tbody id="tbody_slaveInfo"> </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

           






































            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true" onclick="clearMsg();">
                                &times;
                            </button>
                            <h4 class="modal-title" id="myModalLabel">
                                Message
                            </h4>
                        </div>
                        <div class="modal-body">
                            <div id="div_edit_main" class="panel panel-default">
                                <div class="panel-body">
                                    <div id="div_per_main" class="progress" style="margin-bottom: 0px;" hidden>
                                        <div id="div_per" class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                            <span class="sr-only">50% 完成</span>
                                        </div>
                                    </div>
                                    <br/>
                                    <div class="form-horizontal">
                                        <div class="form-group">
                                            <div id="div_MsgOut" class="col-sm-offset-1 col-sm-10">

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal" onclick="clearMsg();">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            </div>

</body>
</html>
